<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI-CHATBOT</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="shell">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">AI</div>
        <div>
          <div class="title">AI-CHATBOT</div>
          <div class="subtitle">System Online</div>
        </div>
      </div>
      <div class="tips">
        <div>Tip: Press <strong>Enter</strong> to send. Use <strong>Image</strong> or <strong>Upload</strong>.</div>
      </div>
    </aside>

    <main class="panel">
      <div id="chat" class="chat" role="log" aria-live="polite"></div>

      <form id="composer" class="composer" onsubmit="return false;">
        <input id="prompt" placeholder="Ask AI-CHATBOT..." autocomplete="off" />
        <button id="sendBtn" class="btn send" type="button">Send</button>
        <button id="imgBtn" class="btn img" type="button">Image</button>
        <input id="fileInput" type="file" style="display:none" />
        <button id="uploadBtn" class="btn" type="button">Upload</button>
      </form>
    </main>

    <aside class="visual">
      <div class="vis">Realtime</div>
    </aside>
  </div>

<script>
/* Frontend behavior: typing, formatting, enter-to-send, file upload */
const chatEl = document.getElementById('chat');
const promptEl = document.getElementById('prompt');
const sendBtn = document.getElementById('sendBtn');
const imgBtn = document.getElementById('imgBtn');
const uploadBtn = document.getElementById('uploadBtn');
const fileInput = document.getElementById('fileInput');

const sessionId = localStorage.getItem('sessionId') || Math.random().toString(36).slice(2);
localStorage.setItem('sessionId', sessionId);

function scrollBottom(){ chatEl.scrollTop = chatEl.scrollHeight; }

function addRow(user=false){
  const r = document.createElement('div');
  r.className = 'row' + (user ? ' user' : '');
  return r;
}

function addBubble(text, kind='ai', isHtml=false){
  const row = addRow(kind === 'user');
  const b = document.createElement('div');
  b.className = 'bubble ' + (kind === 'user' ? 'user' : 'ai');
  if(isHtml) b.innerHTML = text; else b.textContent = text;
  row.appendChild(b);
  chatEl.appendChild(row);
  scrollBottom();
  return b;
}

function createTypingBubble(){
  const row = addRow(false);
  const b = document.createElement('div');
  b.className = 'bubble ai';
  const cursor = document.createElement('span');
  cursor.className = 'cursor';
  b.appendChild(cursor);
  row.appendChild(b);
  chatEl.appendChild(row);
  scrollBottom();
  return b;
}

function typeEffect(el, text, speed=18){
  el.textContent = '';
  const cursor = document.createElement('span'); cursor.className='cursor';
  el.appendChild(cursor);
  let i = 0;
  const iv = setInterval(()=>{
    if(i >= text.length){ cursor.remove(); clearInterval(iv); scrollBottom(); return; }
    cursor.insertAdjacentText('beforebegin', text.charAt(i)); i++; scrollBottom();
  }, speed);
}

/* Format lists and line breaks into HTML safely */
function renderFormatted(el, text){
  if(!text) { el.textContent = ''; return; }
  // escape basic HTML to avoid accidental tags
  const escaped = text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
  // convert numbered lists and dashes into bullets and preserve paragraphs
  let html = escaped
    .replace(/\r\n/g, '\n')
    .replace(/\n{2,}/g, '</p><p>')
    .replace(/\n/g, '<br>')
    .replace(/^\s*\d+\.\s(.+)/gm, '• $1')
    .replace(/^\s*-\s(.+)/gm, '• $1');

  // wrap in paragraph tags if needed
  if(!html.startsWith('<p>')) html = '<p>' + html + '</p>';
  el.innerHTML = html;
}

/* Send chat */
async function sendChat(){
  const prompt = promptEl.value.trim();
  if(!prompt) return;
  addBubble(prompt, 'user');
  promptEl.value = '';
  const status = addBubble('Thinking...', 'ai');
  status.classList.add('sys');

  try{
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ prompt, session: sessionId })
    });
    if(!res.ok){
      const txt = await res.text();
      throw new Error(txt.slice(0,300));
    }
    const j = await res.json();
    status.remove();
    const b = createTypingBubble();
    // render formatted reply with typing effect (we show plain then replace with formatted)
    const reply = j.reply || 'No reply';
    // If reply contains line breaks or list, render formatted after typing
    typeEffect(b, reply, 16);
  }catch(err){
    if(status) status.remove();
    addBubble('Error: ' + (err.message || err), 'ai');
  }
}

/* Image generation */
async function sendImage(){
  const prompt = promptEl.value.trim();
  if(!prompt) return;
  addBubble(prompt, 'user');
  promptEl.value = '';
  const status = addBubble('Generating image...', 'ai'); status.classList.add('sys');

  try{
    const res = await fetch('/api/generate', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ prompt })
    });
    if(!res.ok){
      const t = await res.text(); throw new Error(t.slice(0,300));
    }
    const j = await res.json();
    status.remove();
    const row = addRow(false);
    const b = document.createElement('div'); b.className='bubble ai';
    const img = document.createElement('img');
    img.src = 'data:image/png;base64,' + j.image;
    img.alt = prompt;
    img.style.maxWidth = '420px'; img.style.borderRadius='12px';
    b.appendChild(img); row.appendChild(b); chatEl.appendChild(row); scrollBottom();
  }catch(err){
    if(status) status.remove();
    addBubble('Error: ' + (err.message || err), 'ai');
  }
}

/* File upload (Upload -> /api/upload) */
uploadBtn.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  addBubble('Uploaded: ' + f.name, 'user');
  const fd = new FormData(); fd.append('file', f);
  const status = addBubble('Scanning file...', 'ai'); status.classList.add('sys');
  try{
    const res = await fetch('/api/upload', { method: 'POST', body: fd });
    if(!res.ok){ const t = await res.text(); throw new Error(t.slice(0,300)); }
    const j = await res.json();
    status.remove();
    addBubble(j.summary || j.error || 'No summary available.', 'ai');
  }catch(err){
    if(status) status.remove();
    addBubble('Error: ' + (err.message || err), 'ai');
  }
});

/* Enter to send - no shift required to add newline */
promptEl.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    sendChat();
  }
});

/* Buttons */
sendBtn.addEventListener('click', sendChat);
imgBtn.addEventListener('click', sendImage);

/* initial */
(function init(){
  const b = createTypingBubble();
  typeEffect(b, 'Welcome — I am AI-CHATBOT. Ask me anything.', 16);
})();
</script>
</body>
</html>
