<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AI-CHATBOT</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="app">
  <header>AI-CHATBOT</header>

  <div id="chat" class="chat"></div>

  <div class="input-bar">
    <input id="input" placeholder="Ask AI-CHATBOT…" autocomplete="off">
    <button onclick="sendChat()">Send</button>
    <button id="stopBtn" onclick="stopResponse()">Stop</button>
  </div>
</div>

<script>
let session = localStorage.getItem("session") || crypto.randomUUID();
localStorage.setItem("session", session);

let controller = null;

const chatBox = document.getElementById("chat");
const input = document.getElementById("input");

function addBubble(text, cls) {
  const div = document.createElement("div");
  div.className = "bubble " + cls;
  div.innerHTML = formatText(text);
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
  return div;
}

function formatText(text) {
  return text
    .replace(/\n\n/g,"<br><br>")
    .replace(/\n/g,"<br>")
    .replace(/^\d+\.\s(.+)/gm,"• $1<br>")
    .replace(/^\-\s(.+)/gm,"• $1<br>");
}

function showThinking() {
  return addBubble("AI-CHATBOT is thinking…", "assistant thinking");
}

function stopResponse() {
  if (controller) {
    controller.abort();
    controller = null;
    addBubble("⏹ Response stopped", "assistant");
  }
}

async function sendChat() {
  const text = input.value.trim();
  if (!text) return;

  addBubble(text, "user");
  input.value = "";

  const thinking = showThinking();
  controller = new AbortController();

  try {
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      signal: controller.signal,
      body: JSON.stringify({ prompt: text, session })
    });

    const data = await res.json();
    thinking.remove();

    if (data.reply) {
      typeEffect(addBubble("", "assistant"), data.reply);
    } else {
      addBubble("Error connecting to AI-CHATBOT", "assistant");
    }

  } catch (e) {
    thinking.remove();
    if (e.name === "AbortError") {
      addBubble("⏹ Response stopped", "assistant");
    } else {
      addBubble("Network error", "assistant");
    }
  } finally {
    controller = null;
  }
}

function typeEffect(el, text) {
  let i = 0;
  const speed = 12;
  const formatted = formatText(text);

  const interval = setInterval(() => {
    el.innerHTML = formatted.slice(0, i);
    chatBox.scrollTop = chatBox.scrollHeight;
    i++;
    if (i > formatted.length) clearInterval(interval);
  }, speed);
}

// ENTER KEY SEND
input.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    sendChat();
  }
});
</script>

</body>
</html>
